#!/bin/bash

# CSP Timing Predictor - Startup Script
# Usage: ./start         - Start API server only
#        ./start --all   - Start API server + ngrok
#        ./start --train - Train the model (then start server)
#        ./start --kill  - Stop all processes (server + ngrok)

cd /home/cason/Github/csp-timing-predictor

# Kill processes if --kill flag provided
if [ "$1" == "--kill" ]; then
    echo "Stopping all processes..."
    pkill -f "simple_api_server" 2>/dev/null
    pkill -f "ngrok" 2>/dev/null
    sleep 1

    # Check if any processes are still running
    if pgrep -f "simple_api_server" > /dev/null || pgrep -f "ngrok" > /dev/null; then
        echo "✗ Some processes still running. Forcing kill..."
        pkill -9 -f "simple_api_server" 2>/dev/null
        pkill -9 -f "ngrok" 2>/dev/null
        sleep 1
    fi

    echo "✓ All processes stopped"
    exit 0
fi

# Train model if --train flag provided
if [ "$1" == "--train" ]; then
    echo "Training model..."
    echo "This may take 10-30 minutes depending on GPU availability."
    echo ""
    python train_ultimate.py
    if [ $? -eq 0 ]; then
        echo "✓ Model training complete!"
    else
        echo "✗ Model training failed. Check output above."
        exit 1
    fi
    echo ""
fi

# Kill any existing processes
pkill -f "simple_api_server" 2>/dev/null
pkill -f "ngrok" 2>/dev/null
sleep 1

echo "Starting CSP Timing API Server..."
nohup python simple_api_server.py --port 8000 --reload > server.log 2>&1 &

# Wait for server to start (up to 30 seconds)
echo -n "Waiting for server"
for i in {1..30}; do
    if curl -s http://localhost:8000/ > /dev/null 2>&1; then
        echo ""
        echo "✓ API Server running on http://localhost:8000"
        break
    fi
    echo -n "."
    sleep 1
    if [ $i -eq 30 ]; then
        echo ""
        echo "✗ API Server failed to start. Check server.log"
        exit 1
    fi
done

# Start ngrok if --all flag provided
if [ "$1" == "--all" ]; then
    echo "Starting ngrok tunnel..."
    nohup ngrok http 8000 --domain=destinee-unbenignant-shandra.ngrok-free.dev > ngrok.log 2>&1 &
    sleep 2
    echo "✓ ngrok running at https://destinee-unbenignant-shandra.ngrok-free.dev"
fi

echo ""
echo "Done! Logs:"
echo "  - Server: tail -f server.log"
echo "  - ngrok:  tail -f ngrok.log"
